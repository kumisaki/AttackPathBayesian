# vulnerability.py
import os
import csv
from flask import Blueprint, render_template, request, redirect, url_for, flash, current_app, jsonify
from extensions import mongo

vuln_bp = Blueprint("vuln_bp", __name__)

def calc_probability(cvss, epss):
    try:
        p = 1 - (1 - (float(cvss) / 10)) * (1 - float(epss))
    except Exception:
        p = 0.0
    return round(p, 3)

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() == 'csv'

# @vuln_bp.route('/list')
# def list_vulnerabilities():
#     vulns = list(mongo.db.vulnerabilities.find({}))
#     return render_template("vulnerability_list.html", vulnerabilities=vulns)

@vuln_bp.route('/list')
def list_vulnerabilities():
    vulns = list(mongo.db.vulnerabilities.find({}))
    techniques = list(mongo.db.techniques.find({}))
    technique_map = {t["technique_id"]: t for t in techniques}
    return render_template("vulnerability_list.html", vulnerabilities=vulns, technique_map=technique_map)


@vuln_bp.route('/add', methods=["GET"])
def add_vulnerability_page():
    devices = list(mongo.db.devices.find({}))
    return render_template("vulnerability_add_or_upload.html", devices=devices)

@vuln_bp.route('/add/manual', methods=["POST"])
def add_vulnerability_manual():
    vuln_id = request.form.get("vuln_id")
    desc = request.form.get("desc")
    cvss = request.form.get("cvss")
    epss = request.form.get("epss")
    # attack_tactics = [t.strip() for t in request.form.get("attack_tactics", "").split(",") if t.strip()]
    # attack_techniques = [t.strip() for t in request.form.get("attack_techniques", "").split(",") if t.strip()]
    attack_techniques = request.form.getlist("attack_techniques")
    # print(attack_techniques)
    parent_device_id = request.form.get("parent_device_id")
    prob = calc_probability(cvss, epss)
    mongo.db.vulnerabilities.insert_one({
        "_id": vuln_id,
        "desc": desc,
        "cvss": float(cvss),
        "epss": float(epss),
        "prob": prob,
        # "attack_tactics": attack_tactics,
        "attack_techniques": attack_techniques,
        "parent_device_id": parent_device_id
    })
    flash("Vulnerability added successfully (manual).", "success")
    return redirect(url_for("vuln_bp.list_vulnerabilities"))

@vuln_bp.route('/add/upload', methods=["POST"])
def add_vulnerability_upload():
    if 'file' not in request.files:
        flash("No file part.", "danger")
        return redirect(url_for("vuln_bp.add_vulnerability_page"))
    file = request.files['file']
    if file.filename == '':
        flash("No selected file.", "warning")
        return redirect(url_for("vuln_bp.add_vulnerability_page"))
    if file and allowed_file(file.filename):
        from werkzeug.utils import secure_filename
        filename = secure_filename(file.filename)
        filepath = os.path.join(current_app.config["UPLOAD_FOLDER"], filename)
        file.save(filepath)
        count = 0
        with open(filepath, 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            for row in reader:
                vuln_id = row.get("vuln_id")
                desc = row.get("desc")
                cvss = row.get("cvss")
                epss = row.get("epss")
                attack_techniques = row.get("attack_techniques")
                # print(attack_techniques)
                # attack_tactics = request.form.get("attack_tactics")
                parent_device_id = row.get("parent_device_id")
                if not vuln_id:
                    continue
                prob = calc_probability(cvss, epss)
                mongo.db.vulnerabilities.insert_one({
                    "_id": vuln_id,
                    "desc": desc,
                    "cvss": float(cvss),
                    "epss": float(epss),
                    "prob": prob,
                    # "attack_tactics": attack_tactics,
                    "attack_techniques": attack_techniques,
                    "parent_device_id": parent_device_id
                })
                count += 1
        flash(f"{count} vulnerabilities uploaded successfully.", "success")
        return redirect(url_for("vuln_bp.list_vulnerabilities"))
    else:
        flash("Invalid file format. Only CSV allowed.", "danger")
        return redirect(url_for("vuln_bp.add_vulnerability_page"))

@vuln_bp.route('/edit/<vuln_id>', methods=["GET", "POST"])
def edit_vulnerability(vuln_id):
    vuln = mongo.db.vulnerabilities.find_one({"_id": vuln_id})
    if not vuln:
        flash("Vulnerability not found.", "danger")
        return redirect(url_for("vuln_bp.list_vulnerabilities"))
    if request.method == "POST":
        desc = request.form.get("desc")
        cvss = request.form.get("cvss")
        epss = request.form.get("epss")
        attack_techniques = request.form.getlist("attack_techniques")
        print(attack_techniques)
        # attack_tactics = request.form.get("attack_tactics")
        parent_device_id = request.form.get("parent_device_id")
        prob = calc_probability(cvss, epss)
        mongo.db.vulnerabilities.update_one({"_id": vuln_id}, {"$set": {
            "desc": desc,
            "cvss": float(cvss),
            "epss": float(epss),
            "prob": prob,
            # "attack_tactics": attack_tactics,
            "attack_techniques": attack_techniques,
            "parent_device_id": parent_device_id
        }})
        flash("Vulnerability updated successfully.", "success")
        return redirect(url_for("vuln_bp.list_vulnerabilities"))
    devices = list(mongo.db.devices.find({}))
    return render_template("vulnerability_edit.html", vulnerability=vuln, devices=devices)

@vuln_bp.route('/delete/<vuln_id>')
def delete_vulnerability(vuln_id):
    mongo.db.vulnerabilities.delete_one({"_id": vuln_id})
    flash("Vulnerability deleted.", "info")
    return redirect(url_for("vuln_bp.list_vulnerabilities"))

@vuln_bp.route('/api/techniques/search')
def search_techniques():
    q = request.args.get("q", "")
    results = mongo.db.techniques.find({"technique_name": {"$regex": q, "$options": "i"}}).limit(20)
    return jsonify([
        {"technique_id": t["technique_id"], "technique_name": t["technique_name"]}
        for t in results
    ])

@vuln_bp.route('/api/tactics/by_techniques', methods=["POST"])
def get_tactics_by_techniques():
    data = request.get_json()
    technique_ids = data.get("technique_ids", [])
    mappings = list(mongo.db.techniques_to_tactics.find({"technique_id": {"$in": technique_ids}}))
    tactic_ids = list({m.get("tactic_id") for m in mappings if "tactic_id" in m})
    # print(technique_ids, mappings)
    tactics = list(mongo.db.tactics.find({"tactic_id": {"$in": tactic_ids}}))
    return jsonify([{"tactic_id": t["tactic_id"], "tactic_name": t["tactic_name"]} for t in tactics])

@vuln_bp.route('/api/techniques/by_ids', methods=["POST"])
def get_techniques_by_ids():
    data = request.get_json()
    technique_ids = data.get("technique_ids", [])
    techniques = mongo.db.techniques.find({"technique_id": {"$in": technique_ids}})
    return jsonify([{
        "technique_id": t["technique_id"],
        "technique_name": t["technique_name"]
    } for t in techniques])
