{% extends "base.html" %}
{% block content %}
<h2>Edit Vulnerability</h2>
<form method="POST" action="{{ url_for('vuln_bp.edit_vulnerability', vuln_id=vulnerability._id) }}">
    <div class="form-group">
        <label for="vuln_id">Vulnerability ID</label>
        <input type="text" class="form-control" id="vuln_id" name="vuln_id" value="{{ vulnerability._id }}" disabled>
    </div>
      <div class="form-group">
        <label for="desc">Description</label>
        <div class="input-group">
          <input type="text" class="form-control" id="desc" name="desc" required>
          <div class="input-group-append">
            <button type="button" class="btn btn-outline-info" id="gpt-recommend-btn">Auto map to
              technique</button>
          </div>
        </div>
      </div>
    <div class="form-group">
        <label for="cvss">CVSS Score (0-10)</label>
        <input type="number" class="form-control" id="cvss" name="cvss" step="0.1" min="0" max="10"
            value="{{ vulnerability.cvss }}" required>
    </div>
    <div class="form-group">
        <label for="epss">EPSS (0-1)</label>
        <input type="number" class="form-control" id="epss" name="epss" step="0.01" min="0" max="1"
            value="{{ vulnerability.epss }}" required>
    </div>
    <!-- Technique Dropdown -->
    <div class="form-group">
        <label for="attack_techniques">Attack Techniques</label>
        <select id="attack_techniques" name="attack_techniques" class="form-control" multiple="multiple"></select>
    </div>

    <!-- Corresponding Tactics (display only) -->
    <div class="form-group">
        <label>Corresponding Tactics</label>
        <ul id="attack_tactics" class="list-group"></ul>
    </div>


    <div class="form-group">
        <label for="parent_device_id">Parent Device</label>
        <select id="parent_device_id" name="parent_device_id" class="form-control" required></select>
      </div>
    <button type="submit" class="btn btn-primary">Update Vulnerability</button>
</form>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    const previouslySelectedTechniques = {{ vulnerability.attack_techniques | tojson }};
</script>

<script>
    $(document).ready(function () {
        $('#attack_techniques').select2({
            placeholder: "Select or search techniques",
            ajax: {
                url: "/vulnerability/api/techniques/search",
                dataType: 'json',
                delay: 250,
                data: params => ({ q: params.term }),
                processResults: data => ({
                    results: data.map(t => ({ id: t.technique_id, text: `${t.technique_name} (${t.technique_id})` }))
                }),
                cache: true
            },
            tags: false
        });

        // Preload selected techniques (if editing)
        if (previouslySelectedTechniques && previouslySelectedTechniques.length) {
            $.ajax({
                url: '/vulnerability/api/techniques/by_ids',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ technique_ids: previouslySelectedTechniques }),
                success: function (data) {
                    data.forEach(t => {
                        const option = new Option(`${t.technique_name} (${t.technique_id})`, t.technique_id, true, true);
                        $('#attack_techniques').append(option).trigger('change');
                    });
                }
            });
        }

        // When techniques are selected, fetch and show their tactics
        $('#attack_techniques').on('change', function () {
            const selected = $(this).val();
            $.ajax({
                url: "/vulnerability/api/tactics/by_techniques",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ technique_ids: selected }),
                success: function (data) {
                    const list = $('#attack_tactics').empty();
                    data.forEach(tactic => {
                        list.append(`<li class="list-group-item">${tactic.tactic_name} (${tactic.tactic_id})</li>`);
                    });
                }
            });
        });

        // Trigger initial tactics load
        $('#attack_techniques').trigger('change');

        $('#parent_device_id').select2({
            placeholder: "Search or select a device",
            ajax: {
              url: "/vulnerability/api/devices/search",
              dataType: 'json',
              delay: 250,
              data: params => ({ q: params.term }),
              processResults: data => ({
                results: data
              }),
              cache: true
            }
          });
          
          // Pre-select current device
          const currentDeviceId = "{{ vulnerability.parent_device_id }}";
          const currentDeviceLabel = "{% for device in devices %}{% if device._id == vulnerability.parent_device_id %}{{ device.label }} ({{ device._id }}){% endif %}{% endfor %}";
          if (currentDeviceId) {
            const option = new Option(currentDeviceLabel, currentDeviceId, true, true);
            $('#parent_device_id').append(option).trigger('change');
          }          

    });
</script>
<script>
  $("#gpt-recommend-btn").click(function () {
    const desc = $("#desc").val().trim();
    if (!desc) {
      alert("Please enter a description first.");
      return;
    }

    $.ajax({
      type: "POST",
      url: "/vulnerability/gpt_recommend",
      contentType: "application/json",
      data: JSON.stringify({ description: desc }),
      success: function (response) {
        if (!response.techniques || !Array.isArray(response.techniques)) {
          alert("No valid techniques received.");
          return;
        }

        const $select = $("#attack_techniques");
        $select.empty();

        response.techniques.forEach(function (techId) {
          $("<option>")
            .val(techId)
            .text(techId)
            .prop("selected", true)
            .appendTo($select);
        });

        // âœ… Manually trigger the change event to update tactics
        $select.trigger("change");
      },
      error: function (xhr, status, error) {
        console.error("GPT request failed:", error);
        alert("Failed to get recommendation from GPT.");
      }
    });
  });

</script>

{% endblock %}