{% extends "base.html" %}
{% block content %}
<h2>Add Vulnerability</h2>
<ul class="nav nav-tabs" id="vulnTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="manual-tab" data-toggle="tab" href="#manual" role="tab" aria-controls="manual"
      aria-selected="true">
      Manual Add
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="upload-tab" data-toggle="tab" href="#upload" role="tab" aria-controls="upload"
      aria-selected="false">
      Upload CSV
    </a>
  </li>
</ul>
<div class="tab-content mt-3" id="vulnTabContent">
  <!-- Manual Add Form -->
  <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
    <form method="POST" action="{{ url_for('vuln_bp.add_vulnerability_manual') }}">
      <div class="form-group">
        <label for="vuln_id">Vulnerability ID</label>
        <input type="text" class="form-control" id="vuln_id" name="vuln_id" required>
      </div>
      <div class="form-group">
        <label for="desc">Description</label>
        <input type="text" class="form-control" id="desc" name="desc" required>
      </div>
      <div class="form-group">
        <label for="cvss">CVSS Score (0-10)</label>
        <input type="number" class="form-control" id="cvss" name="cvss" step="0.1" min="0" max="10" required>
      </div>
      <div class="form-group">
        <label for="epss">EPSS (0-1)</label>
        <input type="number" class="form-control" id="epss" name="epss" step="0.01" min="0" max="1" required>
      </div>
      <!-- Technique Dropdown -->
      <div class="form-group">
        <label for="attack_techniques">Attack Techniques</label>
        <select id="attack_techniques" name="attack_techniques" class="form-control"
          multiple="multiple"></select>
      </div>

      <!-- Corresponding Tactics (display only) -->
      <div class="form-group">
        <label>Corresponding Tactics</label>
        <ul id="attack_tactics" class="list-group"></ul>
      </div>
      <div class="form-group">
        <label for="parent_device_id">Parent Device ID</label>
        <select class="form-control" id="parent_device_id" name="parent_device_id" required>
          {% for device in devices %}
          <option value="{{ device._id }}">{{ device.label }} ({{ device.ip_address }})</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Add Vulnerability Manually</button>
    </form>

  </div>
  <!-- CSV Upload Form -->
  <div class="tab-pane fade" id="upload" role="tabpanel" aria-labelledby="upload-tab">
    <form method="POST" action="{{ url_for('vuln_bp.add_vulnerability_upload') }}" enctype="multipart/form-data">
      <div class="form-group">
        <label for="file">Select CSV File</label>
        <input type="file" class="form-control-file" id="file" name="file" accept=".csv" required>
      </div>
      <button type="submit" class="btn btn-secondary">Upload Vulnerabilities CSV</button>
    </form>
    <hr>
    <p class="text-muted">CSV Example (first row as header):</p>
    <pre>
vuln_id,desc,cvss,epss,parent_device_id
vuln_CVE_2019_0211,Apache RCE,9.8,0.8,device_webserver
vuln_CVE_2020_11947,OpenSSL vuln,7.5,0.5,device_webserver
    </pre>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
  #attack_techniques {
    line-height: 1.8px;
  }
</style>
<script>
  $(document).ready(function () {
    $('#attack_techniques').select2({
      placeholder: "Select or search techniques",
      ajax: {
        url: "/vulnerability/api/techniques/search",
        dataType: 'json',
        delay: 250,
        data: params => ({ q: params.term }),
        processResults: data => ({
          results: data.map(t => ({ id: t.technique_id, text: `${t.technique_name} (${t.technique_id})` }))
        }),
        cache: true
      },
      tags: false
    });

    // When techniques are selected, fetch and show their tactics
    $('#attack_techniques').on('change', function () {
      const selected = $(this).val();
      console.log('selection detected')
      $.ajax({
        url: "/vulnerability/api/tactics/by_techniques",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ technique_ids: selected }),
        success: function (data) {
          const list = $('#attack_tactics').empty();
          data.forEach(tactic => {
            list.append(`<li class="list-group-item">${tactic.tactic_name} (${tactic.tactic_id})</li>`);
          });
        }
      });
    });
  });
</script>

{% endblock %}